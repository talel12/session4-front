name: Test Workflow

on:
    push:
        branches:
            - main
    
env:
  BUILD_NUMBER: ${{ github.run_number }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
          - name: clone repo to runner
            uses: actions/checkout@v4

          - name: Login to Docker Hub
            uses: docker/login-action@v3
            with:
              username: ${{ vars.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}
          
          - name: build Image
            run: docker build -t ${{ github.repository }}:${{ env.BUILD_NUMBER }} .
            
          - name: Push Image to Docker Hub
            run: docker push ${{ github.repository }}:${{ env.BUILD_NUMBER }} 

          - name: Tag Image to Latest
            run: docker tag ${{ github.repository }}:${{ env.BUILD_NUMBER }} ${{ github.repository }}:latest
          
          - name: Push Image to Docker Hub
            run: docker push ${{ github.repository }}:latest

    Deployment: 
      runs-on: ubuntu-latest
      needs: ["build-and-push"]
      steps:
        - name: executing remote ssh commands using password
          uses: appleboy/ssh-action@v1.1.0
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            password: ${{ secrets.VPS_PASSWORD }}
            script: |
                sudo docker pull ${{ github.repository }}
                sudo docker stop session4-front-container
                sudo docker rm session4-front-container
                sudo docker run -d -p 5001:5173 --name session4-front-container ${{ github.repository }}
                sudo docker images prune